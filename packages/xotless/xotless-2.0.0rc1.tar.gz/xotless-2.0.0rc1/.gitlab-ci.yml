---
stages:
  - check
  - test
  - build
  - publish

check code smells:
  image: python:3.8
  script:
    - pip install tox
    - tox -e system-lint
  cache:
    paths:
      - .tox
    key: $CI_JOB_NAME
  stage: check
  only:
    refs:
      - master
      - merge_requests
    changes:
      - setup.cfg
      - xotless/*.py
      - xotless/**/*.py

.run_tox_tests: &run_tox_tests
  image: python:$PYTHON
  stage: test
  cache:
    paths:
      - .tox
    key: $CI_JOB_NAME
  script:
    - pip install tox
    - tox -e system-unit

.run_tox_staticcheck: &run_tox_staticcheck
  image: python:3.8
  stage: check
  cache:
    paths:
      - .tox
    key: $CI_JOB_NAME
  script:
    - pip install tox
    - tox -e 3.8-staticcheck

.run_tox_doctest: &run_tox_doctest
  image: python:3.8
  cache:
    paths:
      - .tox
    key: $CI_JOB_NAME
  stage: check
  script:
    - pip install tox
    - tox -e 3.8-doctest


run tests with Python 3.8:
  <<: *run_tox_tests
  needs:
    - check code smells
    - run static checks
  variables:
    PYTHON: "3.8"
  only:
    refs:
      - master
      - merge_requests
    changes:
      - setup.cfg
      - xotless/*.py
      - xotless/**/*.py

run tests with Python 3.9-rc:
  <<: *run_tox_tests
  needs:
    - check code smells
    - run static checks
  variables:
    PYTHON: "3.9-rc"
  only:
    refs:
      - master
      - merge_requests
    changes:
      - setup.cfg
      - xotless/*.py
      - xotless/**/*.py


run static checks:
  <<: *run_tox_staticcheck
  only:
    refs:
      - master
      - merge_requests
    changes:
      - setup.cfg
      - xotless/*.py
      - xotless/**/*.py


run doctests:
  <<: *run_tox_doctest
  only:
    refs:
      - master
      - merge_requests
    changes:
      - docs/source/conf.py
      - docs/**/*.rst
      - setup.cfg
      - xotless/*.py
      - xotless/**/*.py


run coverage tests:
  needs:
    - check code smells
    - run static checks
  image: python:3.8
  stage: test
  script:
    - pip install tox
    - tox -e 3.8-coverage
  only:
    refs:
      - master
      - merge_requests
    changes:
      - setup.cfg
      - xotless/*.py
      - xotless/**/*.py


build source distribution:
  image: python:3.8-alpine
  stage: build
  script:
    - rm -f dist/*
    - apk add git
    - python setup.py sdist
  artifacts:
    paths:
      - dist/
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /^\d+(\.\d+)*(a\d+|b\d+|rc\d+)?(\.post\d+)?$/

build binary distribution:
  image: python:3.8-alpine
  stage: build
  script:
    - pip install wheel
    - apk add git
    - python setup.py bdist_wheel
  artifacts:
    paths:
      - dist/
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /^\d+(\.\d+)*(\.post\d+)?$/


build documentation:
  image: python:3.8
  stage: build
  needs:
    - run doctests
  script:
    - apt-get install -y --no-install-recommends git make
    - pip install -e .
    - pip install sphinx sphinx-rtd-theme
    - make -C docs/ html
  artifacts:
    paths:
      - docs/build/html
  only:
    refs:
      - master
      - merge_requests
    changes:
      - docs/source/conf.py
      - docs/**/*.rst
      - xotless/*.py
      - xotless/**/*.py

publish_pypi:
  variables:
    GIT_STRATEGY: none
  image: python:3.8
  stage: publish
  script:
    - pip install twine
    - twine upload -u "$PYPI_USERNAME" -p "$PYPI_PASSWORD" dist/*
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /^\d+(\.\d+)*(a\d+|b\d+|rc\d+)?(\.post\d+)?$/
  dependencies:
    - build source distribution
    - build binary distribution
  environment:
    name: pypi
    url: https://pypi.org/project/$CI_PROJECT_NAME


publish documentation:
  variables:
    GIT_STRATEGY: none
  stage: publish
  needs:
    - build documentation
  tags:
    - rtd@docs.lahavane.com
  script:
    - |
        ssh rtd@docs.lahavane.com mkdir -p $CI_PROJECT_NAME/.$CI_COMMIT_SHA
        rsync -auvp -e ssh docs/build/html/ rtd@docs.lahavane.com:$CI_PROJECT_NAME/.$CI_COMMIT_SHA/
        ssh rtd@docs.lahavane.com "rm -r /var/www/html/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME; ln -sr /var/www/html/$CI_PROJECT_NAME/.$CI_COMMIT_SHA /var/www/html/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME";
        ssh rtd@docs.lahavane.com "cd /var/www/html/$CI_PROJECT_NAME; ls -al | grep -oE '\.([0-9]|[a-z])*$' | sort | uniq -c | grep '1 ' | grep -oE '\.([0-9]|[a-z])*$' | xargs rm -rf";
  only:
    refs:
      - master
      - merge_requests
    changes:
      - docs/source/conf.py
      - docs/**/*.rst
      - xotless/*.py
      - xotless/**/*.py
